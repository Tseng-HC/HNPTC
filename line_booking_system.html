<!-- ver1.00 Clean UI + Copyright -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ç´„æ²»ç™‚å¸«</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; justify-content: center; align-items: center; z-index: 999; }
        .hidden { display: none; }
        input, select, textarea { font-size: 16px; }
    </style>
</head>
<body class="bg-gray-50 p-3 relative min-h-screen flex flex-col">

    <div class="fixed top-2 right-2 text-[10px] text-gray-300 font-mono z-0 pointer-events-none">ver1.00</div>

    <div id="msg-toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded shadow-lg text-sm z-50 hidden transition-opacity duration-300">æç¤ºè¨Šæ¯</div>

    <div id="loading">
        <div class="text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-500 mx-auto mb-4"></div>
            <p id="loading-text" class="text-gray-500">è¼‰å…¥é ç´„ç³»çµ±...</p>
        </div>
    </div>

    <div id="idle-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-95 z-[1000] flex flex-col justify-center items-center text-white text-center p-6">
        <div class="mb-4 text-5xl">âš ï¸</div>
        <h2 class="text-2xl font-bold mb-3">æ“ä½œæ™‚é–“é€¾æ™‚</h2>
        <p class="mb-8 text-gray-300 text-sm leading-relaxed">ç‚ºäº†ç¢ºä¿è³‡æ–™å®‰å…¨ï¼Œ<br>ç³»çµ±é™åˆ¶å–®æ¬¡æ“ä½œæ™‚é–“ç‚º 20 åˆ†é˜ã€‚<br>é€£ç·šå·²è‡ªå‹•ä¸­æ–·ã€‚</p>
        <button onclick="location.reload()" class="w-full max-w-xs py-3 bg-green-600 rounded-lg font-bold hover:bg-green-700 transition shadow-lg border border-green-500">é‡æ–°æ•´ç†é é¢</button>
    </div>

    <div class="max-w-md mx-auto bg-white rounded-lg shadow-sm p-4 space-y-3 mt-4 flex-grow w-full">
        <h1 class="text-xl font-bold text-center text-green-700 mb-2">é ç´„æ²»ç™‚å¸«</h1>
        
        <div id="form-section">
            <form id="bookingForm" class="space-y-3" onsubmit="return false;">
                <div><label class="block text-sm font-medium text-gray-700">å§“å</label><input type="text" id="name" required onchange="syncData()" class="mt-1 block w-full rounded border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 border p-2 bg-gray-50" placeholder="è«‹è¼¸å…¥å§“å"></div>
                <div><label class="block text-sm font-medium text-gray-700">é›»è©±</label><input type="tel" id="phone" required onchange="syncData()" class="mt-1 block w-full rounded border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 border p-2 bg-gray-50" placeholder="è«‹è¼¸å…¥é›»è©±"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">æŒ‡å®šæ²»ç™‚å¸«</label>
                    <select id="therapist" onchange="syncData()" class="mt-1 block w-full rounded border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 border p-2 bg-white"><option value="">è¼‰å…¥ä¸­...</option></select>
                </div>
                <div><label class="block text-sm font-medium text-gray-700">æœŸæœ›é ç´„æ™‚æ®µ</label><textarea id="time_slots" required rows="3" onchange="syncData()" class="mt-1 block w-full rounded border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 border p-2 bg-gray-50" placeholder="ä¾‹å¦‚ï¼š1/5 ä¸‹åˆ 2:00&#10;1/6 ä¸Šåˆ 10:00"></textarea></div>
                <div class="flex space-x-2 pt-2">
                    <button type="button" onclick="toReview()" class="w-3/5 py-3 bg-green-600 text-white rounded hover:bg-green-700 transition font-bold shadow">ä¸‹ä¸€æ­¥</button>
                    <button type="button" onclick="cancelForm()" class="w-2/5 py-3 bg-red-100 text-red-600 rounded hover:bg-red-200 transition font-bold">å–æ¶ˆ</button>
                </div>
            </form>
        </div>

        <div id="review-section" class="hidden space-y-4">
            <h2 class="text-base font-bold text-gray-700 border-b pb-2">è«‹ç¢ºèªæ‚¨çš„é ç´„å…§å®¹</h2>
            <div class="space-y-3 text-sm bg-gray-50 p-3 rounded">
                <div class="flex justify-between border-b border-gray-200 pb-1"><span class="text-gray-500">å§“å</span><span id="review-name" class="font-bold text-gray-800"></span></div>
                <div class="flex justify-between border-b border-gray-200 pb-1"><span class="text-gray-500">é›»è©±</span><span id="review-phone" class="font-bold text-gray-800"></span></div>
                <div class="flex justify-between border-b border-gray-200 pb-1"><span class="text-gray-500">æŒ‡å®šæ²»ç™‚å¸«</span><span id="review-therapist" class="font-bold text-gray-800"></span></div>
                <div><span class="text-gray-500 block mb-1">æœŸæœ›æ™‚é–“</span><pre id="review-time" class="font-bold text-gray-800 whitespace-pre-wrap font-sans bg-white p-2 rounded border"></pre></div>
            </div>
            <div class="flex flex-col space-y-2 pt-1">
                <button type="button" onclick="confirmSubmit()" class="w-full py-3 bg-green-600 text-white rounded hover:bg-green-700 transition font-bold shadow-lg text-lg">ç¢ºèªé€å‡º</button>
                <div class="flex space-x-2">
                    <button type="button" onclick="backToEdit()" class="w-1/2 py-3 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 transition font-bold">ä¿®æ”¹</button>
                    <button type="button" onclick="cancelForm()" class="w-1/2 py-3 bg-red-100 text-red-600 rounded hover:bg-red-200 transition font-bold">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <div id="final-message" class="hidden flex-col items-center justify-center py-10 space-y-4 text-center">
            <div id="final-icon" class="text-6xl">âœ…</div>
            <h2 id="final-title" class="text-xl font-bold text-gray-800">è³‡æ–™å·²é€å‡º</h2>
            <p id="final-desc" class="text-gray-500 text-sm">ç¨‹å¼å·²å®Œæˆè™•ç†ã€‚<br>è‹¥è¦–çª—æœªè‡ªå‹•é—œé–‰ï¼Œè«‹æ‰‹å‹•é—œé–‰æ­¤é é¢ã€‚</p>
            <button onclick="liff.closeWindow()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded font-bold transition">é—œé–‰è¦–çª—</button>
        </div>
    </div>
    
    <!-- â˜…â˜…â˜… ç‰ˆæ¬Šå®£å‘Šå€ (å‰ç«¯) â˜…â˜…â˜… -->
    <div class="text-center text-[10px] text-gray-300 mt-6 pb-2 w-full">
      &copy; <span id="copyright-year"></span> HNPTC All Rights Reserved. Design by HC. Tseng
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const gasDeploymentId = urlParams.get('gasId');
        let GAS_URL = "";
        if (gasDeploymentId) { GAS_URL = `https://script.google.com/macros/s/${gasDeploymentId}/exec`; } 
        else { console.error("Missing gasId"); alert("ç³»çµ±è¨­å®šéŒ¯èª¤ï¼šç¶²å€ç¼ºå°‘ gasId åƒæ•¸ï¼Œç„¡æ³•é€£çµè³‡æ–™åº«ã€‚"); }
        const liffIdParam = urlParams.get('liffId');        
        const LIFF_ID = liffIdParam; 
        if (!LIFF_ID) {
            console.error("Missing liffId");
            alert("ç³»çµ±è¨­å®šéŒ¯èª¤ï¼šç¶²å€ç¼ºå°‘ liffId åƒæ•¸ï¼Œç„¡æ³•å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ã€‚");
        }


        let g_uid = "", g_displayName = "", heartbeatInterval = null, sessionTimer = null;
        const SESSION_LIMIT = 20 * 60 * 1000;

        window.onload = function() {
            // è‡ªå‹•è¨­å®šç‰ˆæ¬Šå¹´ä»½
            document.getElementById('copyright-year').textContent = new Date().getFullYear();

            if(GAS_URL) {
                initializeLiff();
                fetchTherapistList();
            }
        };

        function fetchTherapistList() {
            const select = document.getElementById('therapist');
            const CACHE_KEY = 'cached_therapists_' + (gasDeploymentId || 'default');
            const cachedData = localStorage.getItem(CACHE_KEY);
            if (cachedData) { try { renderOptions(select, JSON.parse(cachedData)); } catch(e) {} }
            fetch(GAS_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ type: 'get_therapists' }) })
            .then(r => r.json()).then(d => { if (d.therapists && Array.isArray(d.therapists)) { localStorage.setItem(CACHE_KEY, JSON.stringify(d.therapists)); renderOptions(select, d.therapists); } })
            .catch(e => { if(select.options.length <= 1) select.innerHTML = '<option value="ä¸æŒ‡å®š">ä¸æŒ‡å®š (é€£ç·šå¤±æ•—)</option>'; });
        }

        function renderOptions(selectElement, list) {
            const currentVal = selectElement.value; selectElement.innerHTML = ''; 
            if (list.length === 0) { const opt = document.createElement('option'); opt.text = "æš«ç„¡æ²»ç™‚å¸«è³‡æ–™"; selectElement.appendChild(opt); return; }
            list.forEach(name => { const opt = document.createElement('option'); opt.value = name; opt.text = name; selectElement.appendChild(opt); });
            if(currentVal) { for(let i=0; i<selectElement.options.length; i++) { if(selectElement.options[i].value === currentVal) { selectElement.value = currentVal; break; } } }
        }

        function showToast(m, isError = false) { const t = document.getElementById('msg-toast'); t.textContent = m; t.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg text-sm z-50 transition-opacity duration-300 ${isError ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'}`; t.style.display = 'block'; setTimeout(() => { t.style.display = 'none'; }, 3000); }

        async function initializeLiff() {
            try {
                if (typeof liff === 'undefined') throw new Error('LIFF SDK è¼‰å…¥å¤±æ•—');
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isInClient()) { alert("åµæ¸¬åˆ°élineå…§éƒ¨ç€è¦½å™¨ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å¤±æ•ˆï¼Œå»ºè­°ç”¨line appé–‹å•Ÿ"); }
                if (!liff.isLoggedIn()) { if (!liff.isInClient()) { g_uid = "preview_user"; g_displayName = "é è¦½ç”¨æˆ¶"; } else { liff.login(); return; } } else { const idToken = liff.getDecodedIDToken(); g_uid = idToken.sub; g_displayName = idToken.name || "ç”¨æˆ¶"; }
                fetch(GAS_URL, { method: 'POST', mode: 'no-cors', keepalive: true, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: 'track_open', uid: g_uid, name: g_displayName }) }).catch(e => console.log(e));
                if (liff.isInClient()) await liff.sendMessages([{ type: 'text', text: 'é ç´„æ²»ç™‚å¸«' }]);
                startHeartbeat(); startSessionTimer(); document.getElementById('loading').style.display = 'none';
            } catch (error) { console.error('Init Error:', error); document.getElementById('loading').style.display = 'none'; showToast('ç³»çµ±åˆå§‹åŒ–ç•°å¸¸ (è«‹æª¢æŸ¥ LIFF è¨­å®š)', true); }
        }

        function startSessionTimer() { if (sessionTimer) clearTimeout(sessionTimer); sessionTimer = setTimeout(() => { document.getElementById('idle-overlay').classList.remove('hidden'); stopHeartbeat(); }, SESSION_LIMIT); }
        function startHeartbeat() { if (heartbeatInterval) clearInterval(heartbeatInterval); heartbeatInterval = setInterval(() => { fetch(GAS_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type: 'heartbeat', uid: g_uid }) }); }, 1200000); }
        function stopHeartbeat() { if (heartbeatInterval) clearInterval(heartbeatInterval); }

        function syncData(actionType = 'sync_data', useKeepAlive = false) {
            const formData = getFormData(); formData.type = actionType;
            const fetchOptions = { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) };
            if (useKeepAlive) fetchOptions.keepalive = true;
            if (useKeepAlive && actionType !== 'sync_data') { fetch(GAS_URL, fetchOptions).catch(e => console.error(e)); return Promise.resolve(formData); }
            return fetch(GAS_URL, fetchOptions).then(() => { return formData; });
        }

        function toReview() {
            const name = document.getElementById('name').value.trim(); const phone = document.getElementById('phone').value.trim(); const time = document.getElementById('time_slots').value.trim();
            if (!name || !phone || !time) { showToast("è«‹å®Œæ•´å¡«å¯«å§“åã€é›»è©±èˆ‡æœŸæœ›æ™‚é–“", true); return; }
            document.getElementById('review-name').textContent = name; document.getElementById('review-phone').textContent = phone; document.getElementById('review-therapist').textContent = document.getElementById('therapist').value; document.getElementById('review-time').textContent = time;
            syncData('preview_form');
            document.getElementById('form-section').classList.add('hidden'); document.getElementById('review-section').classList.remove('hidden'); window.scrollTo(0, 0);
        }
        function backToEdit() { document.getElementById('review-section').classList.add('hidden'); document.getElementById('form-section').classList.remove('hidden'); }

        async function cancelForm() {
            stopHeartbeat();
            document.getElementById('loading').style.display = 'none';
            showFinalScreen("å·²å–æ¶ˆ", "ğŸš«", "æ‚¨çš„é ç´„æ“ä½œå·²å–æ¶ˆï¼Œå¯ç›´æ¥é—œé–‰è¦–çª—ã€‚");
            const formData = getFormData();
            fetch(GAS_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                keepalive: true, 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ 
                    type: 'cancel_form', 
                    uid: g_uid, 
                    name: g_displayName,
                    form_name: formData.form_name,
                    form_phone: formData.form_phone,
                    form_therapist: formData.form_therapist,
                    form_time: formData.form_time
                }) 
            }).catch(e => console.error(e));
            if (liff.isInClient()) { liff.closeWindow(); }
        }

        async function confirmSubmit() {
            stopHeartbeat();
            const btn = document.querySelector('button[onclick="confirmSubmit()"]'); btn.disabled = true; btn.innerText = "è³‡æ–™å‚³é€ä¸­...";
            try {
                const formData = getFormData();
                if (liff.isInClient()) {
                    const msg = `é ç´„è³‡æ–™å¦‚ä¸‹\nå§“å: ${formData.form_name}\né›»è©±: ${formData.form_phone}\næŒ‡å®šæ²»ç™‚å¸«: ${formData.form_therapist}\næœŸæœ›æ™‚é–“: ${formData.form_time}`;
                    await liff.sendMessages([{ type: 'text', text: msg }]);
                }
                syncData('submit_form', true);
                showFinalScreen("è³‡æ–™å·²é€å‡º", "âœ…", "æ‚¨çš„é ç´„è³‡æ–™å·²é€å‡ºï¼Œå¯ç›´æ¥é—œé–‰è¦–çª—ã€‚");
                if (liff.isInClient()) { liff.closeWindow(); }
            } catch (error) { console.error(error); showToast('å‚³é€å¤±æ•—ï¼Œè«‹é‡æ–°å˜—è©¦', true); btn.disabled = false; btn.innerText = "ç¢ºèªé€å‡º"; startHeartbeat(); }
        }

        function showFinalScreen(title, icon, desc) {
            document.getElementById('form-section').classList.add('hidden'); document.getElementById('review-section').classList.add('hidden'); document.querySelector('h1').classList.add('hidden');
            const finalDiv = document.getElementById('final-message'); document.getElementById('final-title').textContent = title; document.getElementById('final-icon').textContent = icon; document.getElementById('final-desc').innerHTML = desc;
            finalDiv.classList.remove('hidden'); finalDiv.classList.add('flex');
        }

        function getFormData() {
            return {
                uid: g_uid, line_name: g_displayName,
                form_name: document.getElementById('name').value,
                form_phone: document.getElementById('phone').value,
                form_therapist: document.getElementById('therapist').value,
                form_time: document.getElementById('time_slots').value
            };
        }
    </script>
</body>
</html>
