<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•å ±åè¡¨å–®</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary-color: #06c755; --bg-color: #f5f5f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); padding: 20px; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        /* è­¦ç¤ºæ¡†æ¨£å¼ */
        .warning-box {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
            line-height: 1.5;
        }

        .form-group { margin-bottom: 20px; }
        label.section-title { display: block; margin-bottom: 10px; font-weight: bold; color: #333; font-size: 1.05em; border-left: 4px solid var(--primary-color); padding-left: 8px; }
        label.section-title::after { content: " *"; color: #e53935; }
        
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: border-color 0.3s; }
        input[type="text"]:focus { border-color: var(--primary-color); outline: none; }
        
        .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: 10px; }
        .option-label { display: flex; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #eee; border-radius: 6px; transition: background 0.2s; }
        .option-label:hover { background-color: #f9f9f9; }
        .option-label input { margin-right: 10px; transform: scale(1.2); }
        
        button { width: 100%; padding: 14px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; opacity: 0.5; pointer-events: none; transition: opacity 0.3s; }
        button.ready { opacity: 1; pointer-events: auto; }
        button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        
        #status { margin-top: 15px; text-align: center; font-size: 14px; color: #666; min-height: 20px; }

        /* === æ–°å¢ï¼šå¥½å‹é‚€è«‹ Modal æ¨£å¼ === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
            display: none; /* é è¨­éš±è— */
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 12px;
            width: 85%; max-width: 350px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-title { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; color: #333; }
        .modal-desc { color: #666; margin-bottom: 20px; line-height: 1.5; font-size: 0.95em; }
        .modal-btn-group { display: flex; flex-direction: column; gap: 10px; }
        .btn-add-friend {
            background-color: #06c755; color: white; padding: 12px;
            border-radius: 8px; text-decoration: none; font-weight: bold; display: block;
        }
        .btn-skip {
            background-color: transparent; color: #999; padding: 8px;
            border: none; cursor: pointer; font-size: 0.9em;
        }
    </style>
</head>
<body>

<!-- æ–°å¢ï¼šå¥½å‹é‚€è«‹ Modal -->
<div id="friendModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">ğŸ‘‹ æ­¡è¿å…‰è‡¨</div>
        <div class="modal-desc">
            ç‚ºäº†ä¸éŒ¯éæ´»å‹•é€šçŸ¥ï¼Œ<br>å»ºè­°æ‚¨åŠ å…¥å®˜æ–¹å¸³è™Ÿç‚ºå¥½å‹ï¼
        </div>
        <div class="modal-btn-group">
            <!-- href ä¹‹å¾Œæœƒé€é JS å‹•æ…‹å¯«å…¥ -->
            <a id="addFriendLink" href="#" target="_blank" class="btn-add-friend">åŠ å…¥å¥½å‹</a>
            <button class="btn-skip" onclick="closeFriendModal()">æš«æ™‚ä¸è¦ï¼Œç¹¼çºŒå¡«å–®</button>
        </div>
    </div>
</div>

<div class="container">
    <div id="lineWarning" class="warning-box">
        âš ï¸ <strong>æº«é¦¨æé†’</strong><br>
        å¦‚å¸Œæœ›æ”¶åˆ° Line æé†’ï¼Œå»ºè­°ç”¨ Line æƒç¢¼æˆ–ç›´æ¥åœ¨ Line APP å…§é–‹å•Ÿæ­¤é€£çµå¡«å¯«ï¼Œä»¥ç¢ºä¿åŠŸèƒ½æ­£å¸¸ã€‚
    </div>

    <h2>ğŸ“ æ´»å‹•å ±åè¡¨</h2>
    
    <form id="mainForm">
        
        <!-- 1. å ±åæ™‚é–“ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">å ±åæ™‚é–“</label>
            <div class="radio-group">
                <label class="option-label"><input type="radio" name="session" value="1/14 (ä¸‰) 10:00 - 11:30" required> 1/14 (ä¸‰) 10:00 - 11:30</label>
                <label class="option-label"><input type="radio" name="session" value="1/19 (ä¸€) 10:00 - 11:30"> 1/19 (ä¸€) 10:00 - 11:30</label>
                <label class="option-label"><input type="radio" name="session" value="1/25 (æ—¥) 10:00 - 11:30"> 1/25 (æ—¥) 10:00 - 11:30</label>
                <label class="option-label"><input type="radio" name="session" value="1/30 (äº”) 10:00 - 11:30"> 1/30 (äº”) 10:00 - 11:30</label>
            </div>
        </div>

        <!-- 2. å§“å (Text) -->
        <div class="form-group">
            <label class="section-title" for="realName">å§“å</label>
            <input type="text" id="realName" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" required>
        </div>

        <!-- 3. æ€§åˆ¥ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">æ€§åˆ¥</label>
            <div class="radio-group" style="flex-direction: row; gap: 20px;">
                <label class="option-label" style="flex:1"><input type="radio" name="gender" value="ç”·" required> ç”·</label>
                <label class="option-label" style="flex:1"><input type="radio" name="gender" value="å¥³"> å¥³</label>
            </div>
        </div>

        <!-- 4. å¹´é½¡å€æ®µ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">å¹´é½¡å€æ®µ</label>
            <div class="radio-group">
                <label class="option-label"><input type="radio" name="age" value="20æ­²ä»¥ä¸‹" required> 20æ­²ä»¥ä¸‹</label>
                <label class="option-label"><input type="radio" name="age" value="21-35æ­²"> 21-35æ­²</label>
                <label class="option-label"><input type="radio" name="age" value="36-50æ­²"> 36-50æ­²</label>
                <label class="option-label"><input type="radio" name="age" value="51-65æ­²"> 51-65æ­²</label>
                <label class="option-label"><input type="radio" name="age" value="65æ­²ä»¥ä¸Š"> 65æ­²ä»¥ä¸Š</label>
            </div>
        </div>

        <!-- 5. å¾å“ªå¾—çŸ¥ (è¤‡é¸) -->
        <div class="form-group">
            <label class="section-title">å¾å“ªå¾—çŸ¥ (å¯è¤‡é¸)</label>
            <div class="checkbox-group">
                <label class="option-label"><input type="checkbox" name="source" value="ç¶²è·¯"> ç¶²è·¯</label>
                <label class="option-label"><input type="checkbox" name="source" value="è¦ªå‹æ¨è–¦"> è¦ªå‹æ¨è–¦</label>
                <label class="option-label"><input type="checkbox" name="source" value="å¯¦é«”å‚³å–®æˆ–æµ·å ±"> å¯¦é«”å‚³å–®æˆ–æµ·å ±</label>
                <label class="option-label"><input type="checkbox" name="source" value="æ²»ç™‚æ‰€ç¾å ´å¾—çŸ¥"> æ²»ç™‚æ‰€ç¾å ´å¾—çŸ¥</label>
            </div>
        </div>

        <!-- 6. æ˜¯å¦é¡˜æ„æ¥å—lineèª²ç¨‹æé†’é€šçŸ¥ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">æ˜¯å¦é¡˜æ„æ¥å— LINE èª²ç¨‹æé†’é€šçŸ¥</label>
            <div class="radio-group" style="flex-direction: row; gap: 20px;">
                <label class="option-label" style="flex:1"><input type="radio" name="notify" value="æ˜¯" required> æ˜¯</label>
                <label class="option-label" style="flex:1"><input type="radio" name="notify" value="å¦"> å¦</label>
            </div>
        </div>

        <button type="submit" id="submitBtn">ç³»çµ±è¼‰å…¥ä¸­...</button>
    </form>
    
    <div id="status"></div>
</div>

<script>
    // ==========================================
    // [è¨­å®šå€]
    // ==========================================
    const CONFIG = {
        LIFF_ID: "2008806287-9a1hHluF", 
        GAS_URL: "https://script.google.com/macros/s/AKfycbx74tnCe5wk-9WXWR-6Nrb8VE1R3iaXq33T6tpitgjk0PCYreNSoilkQ6QSDhghf4jlPQ/exec",
        
        // è«‹å¡«å…¥æ‚¨çš„å®˜æ–¹å¸³è™Ÿ Basic ID (è¦æœ‰ @ ç¬¦è™Ÿï¼Œä¾‹å¦‚ @123abcde)
        // ç”¨é€”ï¼šç•¶åµæ¸¬åˆ°ä¸æ˜¯å¥½å‹æ™‚ï¼ŒæŒ‰éˆ•é€£çµåˆ°é€™å€‹åŠ å¥½å‹ç¶²å€
        LINE_OA_ID: "@æ‚¨çš„å®˜æ–¹å¸³è™ŸID" 
    };
    // ==========================================

    let userProfile = { userId: "", displayName: "" };
    const submitBtn = document.getElementById('submitBtn');
    const statusDiv = document.getElementById('status');

    // é—œé–‰å¥½å‹é‚€è«‹å½ˆçª—
    function closeFriendModal() {
        document.getElementById('friendModal').style.display = 'none';
    }

    // 1. åˆå§‹åŒ– LIFF
    async function initLiff() {
        try {
            // æ³¨æ„ï¼šè¦ä½¿ç”¨ getFriendship()ï¼Œå¾Œå°å¿…é ˆå·²é€£çµå®˜æ–¹å¸³è™Ÿ (Linked OA)
            await liff.init({ liffId: CONFIG.LIFF_ID });
            
            // åµæ¸¬æ˜¯å¦åœ¨ LINE App å…§é–‹å•Ÿ
            if (!liff.isInClient()) {
                document.getElementById('lineWarning').style.display = 'block';
            }
            
            if (!liff.isLoggedIn()) {
                // ç¬¬ä¸‰å€‹åƒæ•¸ { bot_prompt: 'normal' } æ˜¯ç‚ºäº†åœ¨ç™»å…¥é é¢é¡¯ç¤ºåŠ å¥½å‹é¸é …
                // ä½†ä¸»è¦é‚„æ˜¯ä¾è³´ Console çš„ Linked OA è¨­å®š
                liff.login({ bot_prompt: 'normal' }); 
                return;
            }

            const idToken = liff.getDecodedIDToken();

            if (idToken) {
                userProfile.userId = idToken.sub; 
                userProfile.displayName = idToken.name; 

                if (!userProfile.displayName) {
                    console.warn("æŠ“ä¸åˆ°ä½¿ç”¨è€…åç¨±ï¼Œè«‹ç¢ºèª LIFF Scope æœ‰é–‹å•Ÿ profile");
                    userProfile.displayName = "æœªæˆæ¬Šåç¨±ç”¨æˆ¶";
                }

                console.log("LIFF Ready:", userProfile);
                submitBtn.textContent = "ç¢ºèªé€å‡º";
                submitBtn.classList.add('ready');

                // === æ–°å¢ï¼šæª¢æŸ¥å¥½å‹ç‹€æ…‹é‚è¼¯ ===
                // åªæœ‰åœ¨ LINE App å…§ (isInClient) æ‰èƒ½æº–ç¢ºä½¿ç”¨ getFriendship
                if (liff.isInClient() && CONFIG.LINE_OA_ID.includes("@")) {
                    try {
                        const friendship = await liff.getFriendship();
                        console.log("å¥½å‹ç‹€æ…‹:", friendship.friendFlag);
                        
                        // å¦‚æœä¸æ˜¯å¥½å‹ (friendFlag ç‚º false)ï¼Œé¡¯ç¤ºé‚€è«‹å½ˆçª—
                        if (!friendship.friendFlag) {
                            const addUrl = "https://line.me/R/ti/p/" + CONFIG.LINE_OA_ID;
                            document.getElementById('addFriendLink').href = addUrl;
                            document.getElementById('friendModal').style.display = 'flex';
                        }
                    } catch (fError) {
                        console.error("å¥½å‹ç‹€æ…‹æª¢æŸ¥å¤±æ•— (å¯èƒ½æ˜¯å¾Œå°æœªé€£çµ OA):", fError);
                    }
                }
                // ============================

            } else {
                statusDiv.innerText = "ç„¡æ³•è®€å– ID Token";
            }

        } catch (err) {
            console.error('LIFF Error:', err);
            statusDiv.innerText = "åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚";
        }
    }

    // 2. è¡¨å–®é€å‡º (é‚è¼¯ä¸è®Š)
    document.getElementById('mainForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!CONFIG.GAS_URL || CONFIG.GAS_URL.includes("è«‹å¡«å…¥")) {
            alert("éŒ¯èª¤ï¼šå°šæœªè¨­å®š GAS ç¶²å€");
            return;
        }

        const sourceCheckboxes = document.querySelectorAll('input[name="source"]:checked');
        if (sourceCheckboxes.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€é …ã€Œå¾å“ªå¾—çŸ¥ã€");
            return;
        }
        const sources = Array.from(sourceCheckboxes).map(cb => cb.value).join(', ');

        const session = document.querySelector('input[name="session"]:checked').value;
        const gender = document.querySelector('input[name="gender"]:checked').value;
        const age = document.querySelector('input[name="age"]:checked').value;
        const notify = document.querySelector('input[name="notify"]:checked').value;

        let remindDate = "";
        if (notify === "æ˜¯") {
            const dateMatch = session.match(/(\d+)\/(\d+)/); 
            if (dateMatch) {
                const month = dateMatch[1].padStart(2, '0');
                const day = dateMatch[2].padStart(2, '0');
                const year = new Date().getFullYear(); 
                remindDate = `${year}-${month}-${day}`;
            }
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "è³‡æ–™å‚³é€ä¸­...";
        statusDiv.textContent = "æ­£åœ¨é€£ç·šåˆ° Google Sheet...";
        statusDiv.style.color = "#666";

        const payload = {
            uid: userProfile.userId,
            lineName: userProfile.displayName,
            realName: document.getElementById('realName').value,
            session: session,
            gender: gender,
            age: age,
            source: sources,
            notify: notify,
            remindDate: remindDate 
        };

        try {
            await fetch(CONFIG.GAS_URL, {
                method: "POST",
                body: JSON.stringify(payload),
                mode: "no-cors",
                headers: { "Content-Type": "application/json" }
            });

            statusDiv.textContent = "âœ… å ±åæˆåŠŸï¼è¦–çª—å°‡åœ¨ 3 ç§’å¾Œé—œé–‰";
            statusDiv.style.color = "green";
            submitBtn.textContent = "å ±åæˆåŠŸ";
            setTimeout(() => { liff.closeWindow(); }, 3000);

        } catch (error) {
            console.error('Submit Error:', error);
            statusDiv.textContent = "âŒ å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
            statusDiv.style.color = "red";
            submitBtn.disabled = false;
            submitBtn.textContent = "ç¢ºèªé€å‡º";
        }
    });

    if (CONFIG.LIFF_ID && !CONFIG.LIFF_ID.includes("è«‹å¡«å…¥")) {
        initLiff();
    } else {
        submitBtn.textContent = "è«‹è¨­å®š LIFF ID";
    }
</script>
</body>
</html>
