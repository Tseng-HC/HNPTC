<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•å ±åè¡¨å–®</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary-color: #06c755; --bg-color: #f5f5f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); padding: 20px; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 20px; }
        label.section-title { display: block; margin-bottom: 10px; font-weight: bold; color: #333; font-size: 1.05em; border-left: 4px solid var(--primary-color); padding-left: 8px; }
        
        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: border-color 0.3s; }
        input[type="text"]:focus { border-color: var(--primary-color); outline: none; }
        
        /* å–®é¸èˆ‡è¤‡é¸æ¨£å¼å„ªåŒ– */
        .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: 10px; }
        .option-label { display: flex; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #eee; border-radius: 6px; transition: background 0.2s; }
        .option-label:hover { background-color: #f9f9f9; }
        .option-label input { margin-right: 10px; transform: scale(1.2); }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button { width: 100%; padding: 14px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; opacity: 0.5; pointer-events: none; transition: opacity 0.3s; }
        button.ready { opacity: 1; pointer-events: auto; }
        button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        
        #status { margin-top: 15px; text-align: center; font-size: 14px; color: #666; min-height: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“ æ´»å‹•å ±åè¡¨</h2>
    
    <form id="mainForm">
        
        <!-- 1. å ±åæ™‚é–“ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">å ±åæ™‚é–“</label>
            <div class="radio-group">
                <label class="option-label"><input type="radio" name="session" value="1/14 (ä¸‰) 10:00 - 11:30" required> 1/14 (ä¸‰) 10:00 - 11:30</label>
                <label class="option-label"><input type="radio" name="session" value="1/19 (ä¸€) 10:00 - 11:30"> 1/19 (ä¸€) 10:00 - 11:30</label>
                <label class="option-label"><input type="radio" name="session" value="1/25 (æ—¥) 10:00 - 11:30"> 1/25 (æ—¥) 10:00 - 11:30</label>
                <label class="option-label"><input type="radio" name="session" value="1/30 (äº”) 10:00 - 11:30"> 1/30 (äº”) 10:00 - 11:30</label>
            </div>
        </div>

        <!-- 2. å§“å (Text) -->
        <div class="form-group">
            <label class="section-title" for="realName">å§“å</label>
            <input type="text" id="realName" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" required>
        </div>

        <!-- 3. æ€§åˆ¥ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">æ€§åˆ¥</label>
            <div class="radio-group" style="flex-direction: row; gap: 20px;">
                <label class="option-label" style="flex:1"><input type="radio" name="gender" value="ç”·" required> ç”·</label>
                <label class="option-label" style="flex:1"><input type="radio" name="gender" value="å¥³"> å¥³</label>
            </div>
        </div>

        <!-- 4. å¹´é½¡å€æ®µ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">å¹´é½¡å€æ®µ</label>
            <div class="radio-group">
                <label class="option-label"><input type="radio" name="age" value="20æ­²ä»¥ä¸‹" required> 20æ­²ä»¥ä¸‹</label>
                <label class="option-label"><input type="radio" name="age" value="21-35æ­²"> 21-35æ­²</label>
                <label class="option-label"><input type="radio" name="age" value="36-50æ­²"> 36-50æ­²</label>
                <label class="option-label"><input type="radio" name="age" value="51-65æ­²"> 51-65æ­²</label>
                <label class="option-label"><input type="radio" name="age" value="65æ­²ä»¥ä¸Š"> 65æ­²ä»¥ä¸Š</label>
            </div>
        </div>

        <!-- 5. å¾å“ªå¾—çŸ¥ (è¤‡é¸) -->
        <div class="form-group">
            <label class="section-title">å¾å“ªå¾—çŸ¥ (å¯è¤‡é¸)</label>
            <div class="checkbox-group">
                <label class="option-label"><input type="checkbox" name="source" value="ç¶²è·¯"> ç¶²è·¯</label>
                <label class="option-label"><input type="checkbox" name="source" value="è¦ªå‹æ¨è–¦"> è¦ªå‹æ¨è–¦</label>
                <label class="option-label"><input type="checkbox" name="source" value="å¯¦é«”å‚³å–®æˆ–æµ·å ±"> å¯¦é«”å‚³å–®æˆ–æµ·å ±</label>
                <label class="option-label"><input type="checkbox" name="source" value="æ²»ç™‚æ‰€ç¾å ´å¾—çŸ¥"> æ²»ç™‚æ‰€ç¾å ´å¾—çŸ¥</label>
            </div>
        </div>

        <!-- 6. æ˜¯å¦é¡˜æ„æ¥å—lineèª²ç¨‹æé†’é€šçŸ¥ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">æ˜¯å¦é¡˜æ„æ¥å— LINE èª²ç¨‹æé†’é€šçŸ¥</label>
            <div class="radio-group" style="flex-direction: row; gap: 20px;">
                <label class="option-label" style="flex:1"><input type="radio" name="notify" value="æ˜¯" required> æ˜¯</label>
                <label class="option-label" style="flex:1"><input type="radio" name="notify" value="å¦"> å¦</label>
            </div>
        </div>

        <button type="submit" id="submitBtn">ç³»çµ±è¼‰å…¥ä¸­...</button>
    </form>
    
    <div id="status"></div>
</div>

<script>
    // ==========================================
    // [è¨­å®šå€]
    // ==========================================
    const CONFIG = {
        LIFF_ID: "è«‹å¡«å…¥æ‚¨çš„_LIFF_ID", 
        GAS_URL: "è«‹å¡«å…¥æ‚¨çš„_GAS_ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€" 
    };
    // ==========================================

    let userProfile = { userId: "", displayName: "" };
    const submitBtn = document.getElementById('submitBtn');
    const statusDiv = document.getElementById('status');

    // 1. åˆå§‹åŒ– LIFF
    async function initLiff() {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            const idToken = liff.getDecodedIDToken();

            if (idToken) {
                userProfile.userId = idToken.sub; 
                userProfile.displayName = idToken.name; 

                if (!userProfile.displayName) {
                    console.warn("æŠ“ä¸åˆ°ä½¿ç”¨è€…åç¨±ï¼Œè«‹ç¢ºèª LIFF Scope æœ‰é–‹å•Ÿ profile");
                    userProfile.displayName = "æœªæˆæ¬Šåç¨±ç”¨æˆ¶";
                }

                console.log("LIFF Ready:", userProfile);
                submitBtn.textContent = "ç¢ºèªé€å‡º";
                submitBtn.classList.add('ready');

            } else {
                statusDiv.innerText = "ç„¡æ³•è®€å– ID Token";
            }

        } catch (err) {
            console.error('LIFF Error:', err);
            statusDiv.innerText = "åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚";
        }
    }

    // 2. è¡¨å–®é€å‡º
    document.getElementById('mainForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!CONFIG.GAS_URL || CONFIG.GAS_URL.includes("è«‹å¡«å…¥")) {
            alert("éŒ¯èª¤ï¼šå°šæœªè¨­å®š GAS ç¶²å€");
            return;
        }

        // æ”¶é›†è¤‡é¸æ¡†è³‡æ–™
        const sourceCheckboxes = document.querySelectorAll('input[name="source"]:checked');
        const sources = Array.from(sourceCheckboxes).map(cb => cb.value).join(', ');

        // å–å¾—å–®é¸è³‡æ–™
        const session = document.querySelector('input[name="session"]:checked').value;
        const gender = document.querySelector('input[name="gender"]:checked').value;
        const age = document.querySelector('input[name="age"]:checked').value;
        const notify = document.querySelector('input[name="notify"]:checked').value;

        // è¨ˆç®—æé†’æ—¥æœŸ (ç‚ºäº†ç›¸å®¹å¾Œç«¯è‡ªå‹•æé†’åŠŸèƒ½)
        // é‚è¼¯ï¼šå¦‚æœç”¨æˆ¶é¸ã€Œæ˜¯ã€ï¼Œå‰‡è§£æã€Œå ±åæ™‚é–“ã€ä¸­çš„æ—¥æœŸ (å¦‚ 1/14) ä¸¦è½‰ç‚º YYYY-MM-DD
        let remindDate = "";
        if (notify === "æ˜¯") {
            const dateMatch = session.match(/(\d+)\/(\d+)/); // æŠ“å– 1/14 é€™ç¨®æ ¼å¼
            if (dateMatch) {
                const month = dateMatch[1].padStart(2, '0');
                const day = dateMatch[2].padStart(2, '0');
                const year = new Date().getFullYear(); // å‡è¨­æ˜¯ä»Šå¹´
                remindDate = `${year}-${month}-${day}`;
            }
        }

        // é–å®š UI
        submitBtn.disabled = true;
        submitBtn.textContent = "è³‡æ–™å‚³é€ä¸­...";
        statusDiv.textContent = "æ­£åœ¨é€£ç·šåˆ° Google Sheet...";
        statusDiv.style.color = "#666";

        // æº–å‚™ Payload (è³‡æ–™çµæ§‹)
        const payload = {
            uid: userProfile.userId,
            lineName: userProfile.displayName,
            realName: document.getElementById('realName').value,
            session: session,
            gender: gender,
            age: age,
            source: sources,
            notify: notify,
            remindDate: remindDate // é€™æ¬„æ˜¯ç‚ºäº†è®“æ‚¨çš„ GAS è‡ªå‹•æé†’èƒ½ç¹¼çºŒé‹ä½œ
        };

        try {
            await fetch(CONFIG.GAS_URL, {
                method: "POST",
                body: JSON.stringify(payload),
                mode: "no-cors",
                headers: { "Content-Type": "application/json" }
            });

            // æˆåŠŸ
            statusDiv.textContent = "âœ… å ±åæˆåŠŸï¼è¦–çª—å°‡åœ¨ 3 ç§’å¾Œé—œé–‰";
            statusDiv.style.color = "green";
            submitBtn.textContent = "å ±åæˆåŠŸ";
            
            setTimeout(() => { liff.closeWindow(); }, 3000);

        } catch (error) {
            console.error('Submit Error:', error);
            statusDiv.textContent = "âŒ å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
            statusDiv.style.color = "red";
            submitBtn.disabled = false;
            submitBtn.textContent = "ç¢ºèªé€å‡º";
        }
    });

    // å•Ÿå‹•
    if (CONFIG.LIFF_ID && !CONFIG.LIFF_ID.includes("è«‹å¡«å…¥")) {
        initLiff();
    } else {
        submitBtn.textContent = "è«‹è¨­å®š LIFF ID";
    }
</script>
</body>
</html>
