<!-- ver0.95 -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ­é ¸å°ˆç ”æ´»å‹•å ±åè¡¨å–®</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary-color: #06c755; --bg-color: #f5f5f5; --btn-guest-color: #6c757d; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); padding: 20px; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 20px; }
        label.section-title { display: block; margin-bottom: 10px; font-weight: bold; color: #333; font-size: 1.05em; border-left: 4px solid var(--primary-color); padding-left: 8px; }
        label.section-title::after { content: " *"; color: #e53935; }
        
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: border-color 0.3s; }
        input[type="text"]:focus { border-color: var(--primary-color); outline: none; }
        
        .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: 10px; }
        .option-label { display: flex; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #eee; border-radius: 6px; transition: background 0.2s; }
        .option-label:hover { background-color: #f9f9f9; }
        .option-label input { margin-right: 10px; transform: scale(1.2); }
        
        /* === åº•éƒ¨æŒ‰éˆ•å€ === */
        .action-area { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        
        /* åŠ å¥½å‹å‹¾é¸æ¡†æ¨£å¼ */
        .friend-checkbox-container {
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 15px; font-size: 15px; color: #333;
            background-color: #f8f9fa; padding: 10px; border-radius: 8px;
        }
        .friend-checkbox-container input { margin-right: 8px; transform: scale(1.3); accent-color: var(--primary-color); }

        /* é›™æŒ‰éˆ•æ¨£å¼ */
        .btn-group { display: flex; flex-direction: column; gap: 12px; }
        
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: opacity 0.3s; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; opacity: 0.7; }
        
        .btn-link-submit { background-color: var(--primary-color); color: white; box-shadow: 0 2px 5px rgba(6, 199, 85, 0.3); }
        .btn-guest-submit { background-color: white; color: var(--btn-guest-color); border: 1px solid var(--btn-guest-color); }
        .btn-guest-submit:hover { background-color: #f1f1f1; }

        #status { margin-top: 15px; text-align: center; font-size: 14px; color: #666; min-height: 20px; }
    </style>
</head>
<body>

<div class="container">
    
    <h2>ğŸ“ é ­é ¸å°ˆç ”æ´»å‹•å ±åè¡¨</h2>

    <div class="form-group">
        <!-- æ¨™é¡Œï¼šæ¨¡ä»¿ .section-title é¢¨æ ¼ï¼Œä½†å»é™¤å¿…å¡«æ˜Ÿè™Ÿ -->
        <div style="margin-bottom: 10px; font-weight: bold; color: #333; font-size: 1.05em; border-left: 4px solid var(--primary-color); padding-left: 8px;">
            æ´»å‹•å…§å®¹
        </div>
        
        <!-- å…§å®¹å€å¡Šï¼šä½¿ç”¨é¡ä¼¼ input çš„é‚Šæ¡†é¢¨æ ¼ -->
        <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; line-height: 1.5;">
            <!-- <div style="font-weight: bold; font-size: 1.1em; color: #333; margin-bottom: 4px;">
                é ­é ¸å°ˆç ”ç‰©ç†æ²»ç™‚æ‰€
            </div> -->
            <div style="color: #666; font-size: 16px; margin-bottom: 10px;">
                åå…­å¹´ç¶“é©—å°ˆæ¥­ç‰©ç†æ²»ç™‚å¸«æˆèª²ï¼Œç¾å ´åˆ†æè‚©é ¸åƒµç¡¬ä¾†æºã€å­¸ç¿’è‚©é ¸ç‹€æ³è‡ªæˆ‘æª¢æ¸¬åŠèˆ’ç·©æ–¹æ³•ã€‚<br>
                å…¥å ´ç•¶å¤©é‚„å¯åƒåŠ æŠ½çï¼Œæœ‰æ©Ÿæœƒç²å¾—å°ç¦®ç‰©å“¦ï¼ <br>
                å…è²»å…¥å ´ã€‚åº§ä½æœ‰é™ï¼Œé¡æ»¿ç‚ºæ­¢ã€‚
            </div>
            
            
        </div>
    </div>


    <div class="form-group">
        <!-- æ¨™é¡Œï¼šæ¨¡ä»¿ .section-title é¢¨æ ¼ï¼Œä½†å»é™¤å¿…å¡«æ˜Ÿè™Ÿ -->
        <div style="margin-bottom: 10px; font-weight: bold; color: #333; font-size: 1.05em; border-left: 4px solid var(--primary-color); padding-left: 8px;">
            åœ°é»
        </div>
        
        <!-- å…§å®¹å€å¡Šï¼šä½¿ç”¨é¡ä¼¼ input çš„é‚Šæ¡†é¢¨æ ¼ -->
        <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #fff; line-height: 1.5;">
            <div style="font-weight: bold; font-size: 1.1em; color: #333; margin-bottom: 4px;">
                é ­é ¸å°ˆç ”ç‰©ç†æ²»ç™‚æ‰€
            </div>
            <div style="color: #666; font-size: 16px; margin-bottom: 10px;">
                å°åŒ—å¸‚ä¿¡ç¾©è™æ—è¡—164å··34è™Ÿ1æ¨“
            </div>
            
            <!-- Google Maps æŒ‰éˆ• -->
            <a href="https://www.google.com/maps/search/?api=1&query=é ­é ¸å°ˆç ”ç‰©ç†æ²»ç™‚æ‰€+å°åŒ—å¸‚ä¿¡ç¾©è™æ—è¡—164å··34è™Ÿ1æ¨“" target="_blank" style="display: inline-flex; align-items: center; color: var(--primary-color); text-decoration: none; font-weight: bold; font-size: 0.9em; border: 1px solid var(--primary-color); padding: 6px 12px; border-radius: 20px;">
                ğŸ“ é–‹å•Ÿ Google åœ°åœ–
            </a>
        </div>
    </div>

    
    <form id="mainForm">
        
        <!-- 1. å ±åæ™‚é–“ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">å ±åå ´æ¬¡</label>
            <div class="radio-group">
                <label class="option-label"><input type="radio" name="session" value="1/14 (ä¸‰) 10:00 - 11:30" required> 1/14 (ä¸‰) 10:00 - 11:30</label>
                <label class="option-label"><input type="radio" name="session" value="1/19 (ä¸€) 10:00 - 11:30"> 1/19 (ä¸€) 10:00 - 11:30</label>
                <label class="option-label"><input type="radio" name="session" value="1/25 (æ—¥) 10:00 - 11:30"> 1/25 (æ—¥) 10:00 - 11:30</label>
                <label class="option-label"><input type="radio" name="session" value="1/30 (äº”) 10:00 - 11:30"> 1/30 (äº”) 10:00 - 11:30</label>
            </div>
        </div>

        <!-- 2. å§“å (Text) -->
        <div class="form-group">
            <label class="section-title" for="realName">å§“å</label>
            <input type="text" id="realName" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" required>
        </div>

        <!-- 3. æ€§åˆ¥ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">æ€§åˆ¥</label>
            <div class="radio-group" style="flex-direction: row; gap: 20px;">
                <label class="option-label" style="flex:1"><input type="radio" name="gender" value="ç”·" required> ç”·</label>
                <label class="option-label" style="flex:1"><input type="radio" name="gender" value="å¥³"> å¥³</label>
            </div>
        </div>

        <!-- 4. å¹´é½¡å€æ®µ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">å¹´é½¡å€æ®µ</label>
            <div class="radio-group">
                <label class="option-label"><input type="radio" name="age" value="20æ­²ä»¥ä¸‹" required> 20æ­²ä»¥ä¸‹</label>
                <label class="option-label"><input type="radio" name="age" value="21-35æ­²"> 21-35æ­²</label>
                <label class="option-label"><input type="radio" name="age" value="36-50æ­²"> 36-50æ­²</label>
                <label class="option-label"><input type="radio" name="age" value="51-65æ­²"> 51-65æ­²</label>
                <label class="option-label"><input type="radio" name="age" value="65æ­²ä»¥ä¸Š"> 65æ­²ä»¥ä¸Š</label>
            </div>
        </div>

        <!-- 5. å¾å“ªå¾—çŸ¥ (è¤‡é¸) -->
        <div class="form-group">
            <label class="section-title">å¾å“ªå¾—çŸ¥ (å¯è¤‡é¸)</label>
            <div class="checkbox-group">
                <label class="option-label"><input type="checkbox" name="source" value="ç¶²è·¯"> ç¶²è·¯</label>
                <label class="option-label"><input type="checkbox" name="source" value="è¦ªå‹æ¨è–¦"> è¦ªå‹æ¨è–¦</label>
                <label class="option-label"><input type="checkbox" name="source" value="å¯¦é«”å‚³å–®æˆ–æµ·å ±"> å¯¦é«”å‚³å–®æˆ–æµ·å ±</label>
                <label class="option-label"><input type="checkbox" name="source" value="æ²»ç™‚æ‰€ç¾å ´å¾—çŸ¥"> æ²»ç™‚æ‰€ç¾å ´å¾—çŸ¥</label>
            </div>
        </div>

        <!-- åº•éƒ¨æ“ä½œå€ -->
        <div class="action-area">
            
            <!-- åŠ å…¥å¥½å‹å‹¾é¸æ¡† -->
            <div class="friend-checkbox-container">
                <label style="cursor: pointer; display: flex; align-items: center;">
                    <input type="checkbox" id="addFriendCheck" checked>
                    åŒæ™‚åŠ å…¥å®˜æ–¹å¸³è™Ÿå¥½å‹
                </label>
            </div>

            <!-- é›™æŒ‰éˆ• -->
            <div class="btn-group">
                <button type="button" id="btnLinkSubmit" class="btn-link-submit" onclick="handleLinkSubmit()">
                    ç¢ºèªå ±åä¸¦æ¥æ”¶æé†’ï¼Œéœ€æˆç‚ºå®˜æ–¹lineå¥½å‹ä¸¦ç™»å…¥
                </button>
                <button type="button" id="btnGuestSubmit" class="btn-guest-submit" onclick="handleGuestSubmit()">
                    å ±åä½†ä¸æ¥æ”¶æé†’
                </button>
            </div>
        </div>

    </form>
    
    <div id="status"></div>
</div>

<script>
    // ==========================================
    // [è¨­å®šå€]
    // ==========================================
    const CONFIG = {
        LIFF_ID: "2008806287-9a1hHluF", 
        GAS_URL: "https://script.google.com/macros/s/AKfycbx74tnCe5wk-9WXWR-6Nrb8VE1R3iaXq33T6tpitgjk0PCYreNSoilkQ6QSDhghf4jlPQ/exec",
        // è«‹å¡«å…¥æ‚¨çš„å®˜æ–¹å¸³è™Ÿ Basic ID (è¦æœ‰ @ ç¬¦è™Ÿ)
        LINE_OA_ID: "@246trduk" 
    };
    // ==========================================

    let userProfile = { userId: "", displayName: "" };
    let isGuest = true;
    const statusDiv = document.getElementById('status');

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.onload = function() {
        if (CONFIG.LIFF_ID && !CONFIG.LIFF_ID.includes("è«‹å¡«å…¥")) {
            initLiff();
        } else {
            statusDiv.textContent = "è«‹è¨­å®š LIFF ID";
        }
    };

    // 1. åˆå§‹åŒ– LIFF
    async function initLiff() {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ã€Œç™»å…¥å¾Œè‡ªå‹•å¡«å¯«ã€çš„æš«å­˜è³‡æ–™
            restoreFormData();

            if (liff.isLoggedIn()) {
                isGuest = false;
                const idToken = liff.getDecodedIDToken();
                if (idToken) {
                    userProfile.userId = idToken.sub;
                    userProfile.displayName = idToken.name || "LINE ç”¨æˆ¶";
                }
            } else {
                isGuest = true;
                console.log("è¨ªå®¢æ¨¡å¼");
            }
        } catch (err) {
            console.error('LIFF Error:', err);
            statusDiv.innerText = "åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚";
        }
    }

    // è¡¨å–®é©—è­‰ helper
    function validateForm() {
        const form = document.getElementById('mainForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return false;
        }
        
        const sourceCheckboxes = document.querySelectorAll('input[name="source"]:checked');
        if (sourceCheckboxes.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€é …ã€Œå¾å“ªå¾—çŸ¥ã€");
            return false;
        }
        return true;
    }

    // æ”¶é›†è¡¨å–®è³‡æ–™ helper
    function getFormData(notifyValue) {
        const sourceCheckboxes = document.querySelectorAll('input[name="source"]:checked');
        const sources = Array.from(sourceCheckboxes).map(cb => cb.value).join(', ');
        const session = document.querySelector('input[name="session"]:checked').value;
        const gender = document.querySelector('input[name="gender"]:checked').value;
        const age = document.querySelector('input[name="age"]:checked').value;
        const realName = document.getElementById('realName').value;

        // è¨ˆç®—æé†’æ—¥æœŸ
        let remindDate = "";
        if (notifyValue === "æ˜¯") {
            const dateMatch = session.match(/(\d+)\/(\d+)/); 
            if (dateMatch) {
                const month = dateMatch[1].padStart(2, '0');
                const day = dateMatch[2].padStart(2, '0');
                const year = new Date().getFullYear(); 
                remindDate = `${year}-${month}-${day}`;
            }
        }

        return {
            uid: isGuest ? "guest" : userProfile.userId,
            lineName: isGuest ? "è¨ªå®¢(æœªç™»å…¥)" : userProfile.displayName,
            realName: realName,
            session: session,
            gender: gender,
            age: age,
            source: sources,
            notify: notifyValue,
            remindDate: remindDate
        };
    }

    // [æŒ‰éˆ• 1] ç¢ºèªå ±åä¸¦æ¥æ”¶æé†’
    async function handleLinkSubmit() {
        if (!validateForm()) return;

        // å¦‚æœé‚„æ²’ç™»å…¥
        if (!liff.isLoggedIn()) {
            // [æ–°å¢åŠŸèƒ½] 1. å…ˆè·³å‡ºè­¦å‘Šè¦–çª—
            alert("æé†’ ~ éœ€ç™»å…¥Lineå¾—åˆ°æˆæ¬Šï¼Œæ‰æœ‰è¾¦æ³•æ”¶åˆ°æé†’é€šçŸ¥å–”");

            // 2. æš«å­˜ç›®å‰å¡«å¯«çš„å…§å®¹
            saveFormData();
            
            // 3. è§¸ç™¼ç™»å…¥ (bot_prompt: 'normal' æœƒåœ¨æˆæ¬Šé é¡¯ç¤ºåŠ å¥½å‹é¸é …)
            liff.login({ bot_prompt: 'normal', redirectUri: window.location.href });
            return;
        }

        // å·²ç™»å…¥ï¼Œç›´æ¥é€å‡º (å« ID)
        const data = getFormData("æ˜¯");
        await submitToGAS(data);
    }

    // [æŒ‰éˆ• 2] å ±åä½†ä¸æ¥æ”¶æé†’ (è¨ªå®¢é€å‡º)
    async function handleGuestSubmit() {
        if (!validateForm()) return;
        
        // å¼·åˆ¶è¨­å®šç‚ºä¸æ¥æ”¶ï¼Œä¸”å›  isGuest ç‚º trueï¼Œuid æœƒæ˜¯ "guest" (ç„¡ ID)
        // å³ä½¿ä½¿ç”¨è€…æŒ‰äº†æŒ‰éˆ•1ä½†æ²’ç™»å…¥(åˆ‡æ‰ç•«é¢)ï¼Œå†æŒ‰æ­¤æŒ‰éˆ•ä¹Ÿæœƒæ­£ç¢ºå‚³é€ç„¡IDè³‡æ–™
        const data = getFormData("å¦");
        await submitToGAS(data);
    }

    // é€å‡ºè³‡æ–™åˆ° GAS çš„æ ¸å¿ƒåŠŸèƒ½
    async function submitToGAS(payload) {
        if (!CONFIG.GAS_URL || CONFIG.GAS_URL.includes("è«‹å¡«å…¥")) {
            alert("éŒ¯èª¤ï¼šå°šæœªè¨­å®š GAS ç¶²å€");
            return;
        }

        const btnLink = document.getElementById('btnLinkSubmit');
        const btnGuest = document.getElementById('btnGuestSubmit');
        
        // é–å®šæŒ‰éˆ•
        btnLink.disabled = true;
        btnGuest.disabled = true;
        statusDiv.textContent = "è³‡æ–™å‚³é€ä¸­...";

        try {
            await fetch(CONFIG.GAS_URL, {
                method: "POST",
                body: JSON.stringify(payload),
                mode: "no-cors",
                headers: { "Content-Type": "application/json" }
            });

            statusDiv.textContent = "âœ… å ±åæˆåŠŸï¼";
            statusDiv.style.color = "green";
            
            // æ¸…é™¤æš«å­˜
            localStorage.removeItem('liff_form_backup');

            // æª¢æŸ¥æ˜¯å¦è¦åŠ å…¥å¥½å‹
            const shouldAddFriend = document.getElementById('addFriendCheck').checked;
            
            // å¦‚æœéœ€è¦è·³è½‰åŠ å¥½å‹ (ä¸”å·²æœ‰å®˜æ–¹å¸³è™ŸID)
            if (shouldAddFriend && CONFIG.LINE_OA_ID.includes("@")) {
                setTimeout(() => {
                    alert("å ±åæˆåŠŸï¼å³å°‡å‰å¾€å®˜æ–¹å¸³è™Ÿ...");
                    window.location.href = "https://line.me/R/ti/p/" + CONFIG.LINE_OA_ID;
                }, 1000);
            } else {
                setTimeout(() => {
                    alert("å ±åæˆåŠŸï¼");
                    if (liff.isInClient()) {
                        liff.closeWindow();
                    }
                }, 500);
            }

        } catch (error) {
            console.error('Submit Error:', error);
            statusDiv.textContent = "âŒ å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
            statusDiv.style.color = "red";
            btnLink.disabled = false;
            btnGuest.disabled = false;
        }
    }

    // === æš«å­˜èˆ‡é‚„åŸåŠŸèƒ½ (è§£æ±ºç™»å…¥è·³è½‰å¾Œè³‡æ–™æ¶ˆå¤±å•é¡Œ) ===
    function saveFormData() {
        const form = document.getElementById('mainForm');
        const formData = {};
        
        // å„²å­˜æ–‡å­—è¼¸å…¥
        formData.realName = document.getElementById('realName').value;
        
        // å„²å­˜å–®é¸
        const radios = ['session', 'gender', 'age'];
        radios.forEach(name => {
            const checked = document.querySelector(`input[name="${name}"]:checked`);
            if (checked) formData[name] = checked.value;
        });

        // å„²å­˜è¤‡é¸
        const sources = [];
        document.querySelectorAll(`input[name="source"]:checked`).forEach(cb => sources.push(cb.value));
        formData.source = sources;

        // å„²å­˜åŠ å¥½å‹å‹¾é¸ç‹€æ…‹
        formData.addFriend = document.getElementById('addFriendCheck').checked;
        
        // æ¨™è¨˜é€™æ˜¯ä¸€å€‹ã€Œæº–å‚™é€å‡ºã€çš„ç‹€æ…‹
        formData.autoSubmit = true; 

        localStorage.setItem('liff_form_backup', JSON.stringify(formData));
    }

    function restoreFormData() {
        const saved = localStorage.getItem('liff_form_backup');
        if (!saved) return;

        try {
            const data = JSON.parse(saved);
            
            // é‚„åŸæ–‡å­—
            if (data.realName) document.getElementById('realName').value = data.realName;
            
            // é‚„åŸå–®é¸
            ['session', 'gender', 'age'].forEach(name => {
                if (data[name]) {
                    const el = document.querySelector(`input[name="${name}"][value="${data[name]}"]`);
                    if (el) el.checked = true;
                }
            });

            // é‚„åŸè¤‡é¸
            if (data.source && Array.isArray(data.source)) {
                data.source.forEach(val => {
                    const el = document.querySelector(`input[name="source"][value="${val}"]`);
                    if (el) el.checked = true;
                });
            }

            // é‚„åŸåŠ å¥½å‹å‹¾é¸
            if (data.addFriend !== undefined) {
                document.getElementById('addFriendCheck').checked = data.addFriend;
            }

            // [æ ¸å¿ƒé‚è¼¯]ï¼šå¦‚æœæ¨™è¨˜ç‚ºè‡ªå‹•é€å‡ºï¼Œä¸”å·²ç™»å…¥æˆåŠŸï¼Œå‰‡è‡ªå‹•è§¸ç™¼é€å‡º (é”æˆã€Œç™»å…¥å¾Œå‚³é€IDè³‡æ–™ã€)
            // å¦‚æœæ²’ç™»å…¥(ä½¿ç”¨è€…åˆ‡æ‰ç™»å…¥ç•«é¢å›ä¾†)ï¼Œé€™è£¡ä¸æœƒåŸ·è¡Œï¼Œä½¿ç”¨è€…å¯é»æ“Šç¬¬äºŒé¡†æŒ‰éˆ•é€²è¡Œç„¡IDå‚³é€
            if (data.autoSubmit && liff.isLoggedIn()) {
                console.log("åµæ¸¬åˆ°ç™»å…¥å›è¨ªï¼Œè‡ªå‹•é€å‡º...");
                handleLinkSubmit();
            }
            
        } catch (e) {
            console.error("é‚„åŸè³‡æ–™å¤±æ•—", e);
        }
    }
</script>
</body>
</html>
