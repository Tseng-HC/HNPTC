<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•å ±åè¡¨å–®</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --primary-color: #06c755; --bg-color: #f5f5f5; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); padding: 20px; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        /* å€å¡Šæ¨£å¼ */
        .auth-box {
            background-color: #f0f9ff;
            border: 1px solid #bae3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .btn-line-login {
            background-color: #06c755; color: white; padding: 10px 20px;
            border-radius: 6px; text-decoration: none; font-weight: bold;
            display: inline-block; margin-top: 5px; cursor: pointer; border: none; font-size: 14px;
        }

        /* è­¦ç¤ºæ¡† */
        .warning-box {
            background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;
            padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;
            display: none; line-height: 1.5;
        }

        .form-group { margin-bottom: 20px; }
        label.section-title { display: block; margin-bottom: 10px; font-weight: bold; color: #333; font-size: 1.05em; border-left: 4px solid var(--primary-color); padding-left: 8px; }
        label.section-title::after { content: " *"; color: #e53935; }
        
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: border-color 0.3s; }
        input[type="text"]:focus { border-color: var(--primary-color); outline: none; }
        
        .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: 10px; }
        .option-label { display: flex; align-items: center; cursor: pointer; padding: 8px; border: 1px solid #eee; border-radius: 6px; transition: background 0.2s; }
        .option-label:hover { background-color: #f9f9f9; }
        .option-label input { margin-right: 10px; transform: scale(1.2); }
        
        button#submitBtn { width: 100%; padding: 14px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; opacity: 0.5; pointer-events: none; transition: opacity 0.3s; }
        button#submitBtn.ready { opacity: 1; pointer-events: auto; }
        button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        
        #status { margin-top: 15px; text-align: center; font-size: 14px; color: #666; min-height: 20px; }

        /* === å¥½å‹é‚€è«‹ Modal === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center;
            z-index: 1000; display: none;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 12px;
            width: 85%; max-width: 350px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-title { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; color: #333; }
        .modal-desc { color: #666; margin-bottom: 20px; line-height: 1.5; font-size: 0.95em; }
        .modal-btn-group { display: flex; flex-direction: column; gap: 10px; }
        .btn-add-friend { background-color: #06c755; color: white; padding: 12px; border-radius: 8px; text-decoration: none; font-weight: bold; display: block; }
        .btn-skip { background-color: transparent; color: #999; padding: 8px; border: none; cursor: pointer; font-size: 0.9em; }
    </style>
</head>
<body>

<!-- å¥½å‹é‚€è«‹ Modal (åƒ…å°å·²ç™»å…¥ä½†æœªåŠ å¥½å‹è€…é¡¯ç¤º) -->
<div id="friendModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-title">ğŸ‘‹ æ­¡è¿å…‰è‡¨</div>
        <div class="modal-desc">
            ç‚ºäº†ä¸éŒ¯éæ´»å‹•é€šçŸ¥ï¼Œ<br>å»ºè­°æ‚¨åŠ å…¥å®˜æ–¹å¸³è™Ÿç‚ºå¥½å‹ï¼
        </div>
        <div class="modal-btn-group">
            <a id="addFriendLink" href="#" target="_blank" class="btn-add-friend">åŠ å…¥å¥½å‹</a>
            <button class="btn-skip" onclick="closeFriendModal()">æš«æ™‚ä¸è¦ï¼Œç¹¼çºŒå¡«å–®</button>
        </div>
    </div>
</div>

<div class="container">
    <!-- è¨ªå®¢/ç™»å…¥ç‹€æ…‹å€å¡Š -->
    <div id="authSection" class="auth-box" style="display:none;">
        <div>ç›®å‰ç‚º <strong>è¨ªå®¢æ¨¡å¼</strong></div>
        <div style="font-size: 0.85em; color: #666; margin: 8px 0;">
            è¨ªå®¢ç„¡æ³•æ”¶åˆ° LINE è‡ªå‹•æé†’ã€‚<br>è‹¥éœ€è¦æé†’åŠŸèƒ½ï¼Œè«‹å…ˆç™»å…¥ã€‚
        </div>
        <button onclick="loginLine()" class="btn-line-login">LINE ç™»å…¥</button>
        <div style="margin-top: 10px; font-size: 0.9em;">
             æˆ– <a id="guestAddFriendLink" href="#" target="_blank" style="color: #06c755;">åŠ å…¥å®˜æ–¹å¸³è™Ÿå¥½å‹</a>
        </div>
    </div>

    <!-- ç™»å…¥æˆåŠŸæ­¡è¿å€å¡Š -->
    <div id="welcomeSection" class="auth-box" style="display:none; background-color: #e8f5e9; border-color: #c8e6c9;">
        å—¨ï¼Œ<strong id="displayLineName">User</strong>ï¼<br>
        <span style="font-size: 0.85em; color: #4caf50;">å·²é€£çµ LINE å¸³è™Ÿï¼Œå¯æ¥æ”¶é€šçŸ¥ã€‚</span>
    </div>

    <div id="lineWarning" class="warning-box">
        âš ï¸ <strong>æ³¨æ„</strong><br>
        æ‚¨é¸æ“‡äº†ã€Œé¡˜æ„æ¥å—é€šçŸ¥ã€ï¼Œä½†å°šæœªç™»å…¥ LINEã€‚<br>
        è«‹é»æ“Šä¸Šæ–¹çš„ã€ŒLINE ç™»å…¥ã€æŒ‰éˆ•ï¼Œå¦å‰‡ç³»çµ±ç„¡æ³•å‚³é€é€šçŸ¥çµ¦æ‚¨ã€‚
    </div>

    <h2>ğŸ“ æ´»å‹•å ±åè¡¨</h2>
    
    <form id="mainForm">
        
        <!-- 1. å ±åæ™‚é–“ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">å ±åæ™‚é–“</label>
            <div class="radio-group">
                <label class="option-label"><input type="radio" name="session" value="1/14 (ä¸‰) 10:00 - 11:30" required> 1/14 (ä¸‰) 10:00 - 11:30</label>
                <label class="option-label"><input type="radio" name="session" value="1/19 (ä¸€) 10:00 - 11:30"> 1/19 (ä¸€) 10:00 - 11:30</label>
                <label class="option-label"><input type="radio" name="session" value="1/25 (æ—¥) 10:00 - 11:30"> 1/25 (æ—¥) 10:00 - 11:30</label>
                <label class="option-label"><input type="radio" name="session" value="1/30 (äº”) 10:00 - 11:30"> 1/30 (äº”) 10:00 - 11:30</label>
            </div>
        </div>

        <!-- 2. å§“å (Text) -->
        <div class="form-group">
            <label class="section-title" for="realName">å§“å</label>
            <input type="text" id="realName" placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å" required>
        </div>

        <!-- 3. æ€§åˆ¥ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">æ€§åˆ¥</label>
            <div class="radio-group" style="flex-direction: row; gap: 20px;">
                <label class="option-label" style="flex:1"><input type="radio" name="gender" value="ç”·" required> ç”·</label>
                <label class="option-label" style="flex:1"><input type="radio" name="gender" value="å¥³"> å¥³</label>
            </div>
        </div>

        <!-- 4. å¹´é½¡å€æ®µ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">å¹´é½¡å€æ®µ</label>
            <div class="radio-group">
                <label class="option-label"><input type="radio" name="age" value="20æ­²ä»¥ä¸‹" required> 20æ­²ä»¥ä¸‹</label>
                <label class="option-label"><input type="radio" name="age" value="21-35æ­²"> 21-35æ­²</label>
                <label class="option-label"><input type="radio" name="age" value="36-50æ­²"> 36-50æ­²</label>
                <label class="option-label"><input type="radio" name="age" value="51-65æ­²"> 51-65æ­²</label>
                <label class="option-label"><input type="radio" name="age" value="65æ­²ä»¥ä¸Š"> 65æ­²ä»¥ä¸Š</label>
            </div>
        </div>

        <!-- 5. å¾å“ªå¾—çŸ¥ (è¤‡é¸) -->
        <div class="form-group">
            <label class="section-title">å¾å“ªå¾—çŸ¥ (å¯è¤‡é¸)</label>
            <div class="checkbox-group">
                <label class="option-label"><input type="checkbox" name="source" value="ç¶²è·¯"> ç¶²è·¯</label>
                <label class="option-label"><input type="checkbox" name="source" value="è¦ªå‹æ¨è–¦"> è¦ªå‹æ¨è–¦</label>
                <label class="option-label"><input type="checkbox" name="source" value="å¯¦é«”å‚³å–®æˆ–æµ·å ±"> å¯¦é«”å‚³å–®æˆ–æµ·å ±</label>
                <label class="option-label"><input type="checkbox" name="source" value="æ²»ç™‚æ‰€ç¾å ´å¾—çŸ¥"> æ²»ç™‚æ‰€ç¾å ´å¾—çŸ¥</label>
            </div>
        </div>

        <!-- 6. æ˜¯å¦é¡˜æ„æ¥å—lineèª²ç¨‹æé†’é€šçŸ¥ (å–®é¸) -->
        <div class="form-group">
            <label class="section-title">æ˜¯å¦é¡˜æ„æ¥å— LINE èª²ç¨‹æé†’é€šçŸ¥</label>
            <div class="radio-group" style="flex-direction: row; gap: 20px;">
                <label class="option-label" style="flex:1"><input type="radio" name="notify" value="æ˜¯" required onchange="checkNotify(this)"> æ˜¯</label>
                <label class="option-label" style="flex:1"><input type="radio" name="notify" value="å¦" onchange="checkNotify(this)"> å¦</label>
            </div>
        </div>

        <button type="submit" id="submitBtn">ç³»çµ±è¼‰å…¥ä¸­...</button>
    </form>
    
    <div id="status"></div>
</div>

<script>
    // ==========================================
    // [è¨­å®šå€]
    // ==========================================
    const CONFIG = {
        LIFF_ID: "2008806287-9a1hHluF", 
        GAS_URL: "https://script.google.com/macros/s/AKfycbx74tnCe5wk-9WXWR-6Nrb8VE1R3iaXq33T6tpitgjk0PCYreNSoilkQ6QSDhghf4jlPQ/exec",
        
        // è«‹å¡«å…¥æ‚¨çš„å®˜æ–¹å¸³è™Ÿ Basic ID (è¦æœ‰ @ ç¬¦è™Ÿ)
        LINE_OA_ID: "@æ‚¨çš„å®˜æ–¹å¸³è™ŸID" 
    };
    // ==========================================

    let userProfile = { userId: "", displayName: "" };
    let isGuest = true; // é è¨­ç‚ºè¨ªå®¢
    const submitBtn = document.getElementById('submitBtn');
    const statusDiv = document.getElementById('status');

    function closeFriendModal() {
        document.getElementById('friendModal').style.display = 'none';
    }

    // è§¸ç™¼æ‰‹å‹•ç™»å…¥
    function loginLine() {
        if (!liff.isLoggedIn()) {
            // bot_prompt: 'normal' æœƒåœ¨ç™»å…¥æ™‚é †ä¾¿å•è¦ä¸è¦åŠ å¥½å‹
            liff.login({ bot_prompt: 'normal' });
        }
    }

    // ç•¶ç”¨æˆ¶åˆ‡æ›ã€Œæ¥æ”¶é€šçŸ¥ã€é¸é …æ™‚æª¢æŸ¥æ˜¯å¦ç‚ºè¨ªå®¢
    function checkNotify(radio) {
        const warning = document.getElementById('lineWarning');
        if (radio.value === "æ˜¯" && isGuest) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }
    }

    // 1. åˆå§‹åŒ– LIFF
    async function initLiff() {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            
            // è¨­å®šåŠ å…¥å¥½å‹é€£çµ (çµ¦è¨ªå®¢ç”¨çš„)
            if (CONFIG.LINE_OA_ID) {
                const oaLink = "https://line.me/R/ti/p/" + CONFIG.LINE_OA_ID;
                document.getElementById('guestAddFriendLink').href = oaLink;
                document.getElementById('addFriendLink').href = oaLink;
            }

            // === é—œéµä¿®æ”¹ï¼šä¸å¼·åˆ¶ç™»å…¥ ===
            if (!liff.isLoggedIn()) {
                // [è¨ªå®¢æ¨¡å¼]
                isGuest = true;
                console.log("è¨ªå®¢æ¨¡å¼");
                document.getElementById('authSection').style.display = 'block'; // é¡¯ç¤ºç™»å…¥æŒ‰éˆ•
                
                // è§£é–é€å‡ºæŒ‰éˆ• (è®“è¨ªå®¢å¯ä»¥å¡«è¡¨)
                submitBtn.textContent = "ç¢ºèªé€å‡º";
                submitBtn.classList.add('ready');

            } else {
                // [å·²ç™»å…¥æ¨¡å¼]
                isGuest = false;
                handleLoggedInUser();
            }

        } catch (err) {
            console.error('LIFF Error:', err);
            statusDiv.innerText = "åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šã€‚";
        }
    }

    // è™•ç†å·²ç™»å…¥ä½¿ç”¨è€…çš„é‚è¼¯
    async function handleLoggedInUser() {
        const idToken = liff.getDecodedIDToken();

        if (idToken) {
            userProfile.userId = idToken.sub; 
            userProfile.displayName = idToken.name || "LINE ç”¨æˆ¶"; 

            console.log("LIFF Ready:", userProfile);
            
            // æ›´æ–° UI
            document.getElementById('welcomeSection').style.display = 'block';
            document.getElementById('displayLineName').textContent = userProfile.displayName;
            
            // è§£é–æŒ‰éˆ•
            submitBtn.textContent = "ç¢ºèªé€å‡º";
            submitBtn.classList.add('ready');

            // æª¢æŸ¥å¥½å‹ç‹€æ…‹ (åƒ…åœ¨ APP å…§æœ‰æ•ˆ)
            if (liff.isInClient() && CONFIG.LINE_OA_ID.includes("@")) {
                try {
                    const friendship = await liff.getFriendship();
                    if (!friendship.friendFlag) {
                        document.getElementById('friendModal').style.display = 'flex';
                    }
                } catch (e) {
                    console.warn("ç„¡æ³•å–å¾—å¥½å‹ç‹€æ…‹");
                }
            }
        }
    }

    // 2. è¡¨å–®é€å‡º
    document.getElementById('mainForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!CONFIG.GAS_URL || CONFIG.GAS_URL.includes("è«‹å¡«å…¥")) {
            alert("éŒ¯èª¤ï¼šå°šæœªè¨­å®š GAS ç¶²å€");
            return;
        }

        // è¨ªå®¢é˜²å‘†æª¢æŸ¥ï¼šå¦‚æœé¸äº†ã€Œæ˜¯ã€é€šçŸ¥ï¼Œä½†æ²’ç™»å…¥ï¼Œå†æ¬¡æé†’
        const notifyValue = document.querySelector('input[name="notify"]:checked').value;
        if (isGuest && notifyValue === "æ˜¯") {
            const confirmGuest = confirm("æ‚¨é¸æ“‡äº†ã€Œæ¥å—æé†’ã€ï¼Œä½†æ‚¨ç›®å‰ç‚ºè¨ªå®¢æ¨¡å¼ (æœªç™»å…¥ LINE)ï¼Œç³»çµ±å°‡ç„¡æ³•å‚³é€é€šçŸ¥ã€‚\n\nè¦ç¹¼çºŒé€å‡ºå—ï¼Ÿ(è‹¥è¦æ”¶åˆ°é€šçŸ¥è«‹æŒ‰å–æ¶ˆä¸¦é€²è¡Œç™»å…¥)");
            if (!confirmGuest) return;
        }

        const sourceCheckboxes = document.querySelectorAll('input[name="source"]:checked');
        if (sourceCheckboxes.length === 0) {
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€é …ã€Œå¾å“ªå¾—çŸ¥ã€");
            return;
        }
        const sources = Array.from(sourceCheckboxes).map(cb => cb.value).join(', ');

        const session = document.querySelector('input[name="session"]:checked').value;
        const gender = document.querySelector('input[name="gender"]:checked').value;
        const age = document.querySelector('input[name="age"]:checked').value;

        let remindDate = "";
        // åªæœ‰åœ¨éè¨ªå®¢ (æœ‰ UID) ä¸”åŒæ„é€šçŸ¥æ™‚ï¼Œæ‰è¨ˆç®—æ—¥æœŸ
        if (!isGuest && notifyValue === "æ˜¯") {
            const dateMatch = session.match(/(\d+)\/(\d+)/); 
            if (dateMatch) {
                const month = dateMatch[1].padStart(2, '0');
                const day = dateMatch[2].padStart(2, '0');
                const year = new Date().getFullYear(); 
                remindDate = `${year}-${month}-${day}`;
            }
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "è³‡æ–™å‚³é€ä¸­...";
        statusDiv.textContent = "æ­£åœ¨é€£ç·šåˆ° Google Sheet...";
        statusDiv.style.color = "#666";

        const payload = {
            // å¦‚æœæ˜¯è¨ªå®¢ï¼ŒUID å‚³é€ 'guest'ï¼ŒLineåç¨±å‚³é€ 'è¨ªå®¢'
            uid: userProfile.userId || "guest",
            lineName: userProfile.displayName || "è¨ªå®¢(æœªç™»å…¥)",
            realName: document.getElementById('realName').value,
            session: session,
            gender: gender,
            age: age,
            source: sources,
            notify: notifyValue,
            remindDate: remindDate 
        };

        try {
            await fetch(CONFIG.GAS_URL, {
                method: "POST",
                body: JSON.stringify(payload),
                mode: "no-cors",
                headers: { "Content-Type": "application/json" }
            });

            statusDiv.textContent = "âœ… å ±åæˆåŠŸï¼è¦–çª—å°‡åœ¨ 3 ç§’å¾Œé—œé–‰";
            statusDiv.style.color = "green";
            submitBtn.textContent = "å ±åæˆåŠŸ";
            
            // åªæœ‰åœ¨ LIFF è¦–çª—å…§æ‰è‡ªå‹•é—œé–‰ï¼ŒPC ç€è¦½å™¨å‰‡ä¸é—œ
            if (liff.isInClient()) {
                setTimeout(() => { liff.closeWindow(); }, 3000);
            } else {
                setTimeout(() => { alert("è³‡æ–™å·²é€å‡ºï¼æ‚¨å¯ä»¥é—œé–‰æ­¤åˆ†é ã€‚"); }, 500);
            }

        } catch (error) {
            console.error('Submit Error:', error);
            statusDiv.textContent = "âŒ å‚³é€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
            statusDiv.style.color = "red";
            submitBtn.disabled = false;
            submitBtn.textContent = "ç¢ºèªé€å‡º";
        }
    });

    if (CONFIG.LIFF_ID && !CONFIG.LIFF_ID.includes("è«‹å¡«å…¥")) {
        initLiff();
    } else {
        submitBtn.textContent = "è«‹è¨­å®š LIFF ID";
    }
</script>
</body>
</html>
